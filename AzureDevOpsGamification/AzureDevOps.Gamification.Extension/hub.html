<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Gamification Hub</title>
    <script src="lib/VSS.SDK.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
        }
        .hub-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .hub-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .hub-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        .filters-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-label {
            font-size: 12px;
            font-weight: 500;
            color: #666;
        }
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .content-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        .codegraph-container {
            height: 400px;
            border: 1px solid #e1e5e9;
            border-radius: 4px;
            position: relative;
        }
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
        }
        .ranking-table th,
        .ranking-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        .ranking-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        .rank-number {
            font-weight: bold;
            color: #0078d4;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-style: italic;
            color: #666;
        }
        .error {
            color: #d73a49;
            text-align: center;
            padding: 20px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #0078d4;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 14px;
            color: #666;
        }
        .full-width-panel {
            grid-column: 1 / -1;
        }
        .chart-container {
            height: 300px;
            margin-top: 15px;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .activity-calendar {
            display: grid;
            grid-template-columns: repeat(53, 1fr);
            gap: 2px;
            margin-top: 15px;
        }
        .activity-day {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            background: #ebedf0;
            cursor: pointer;
        }
        .activity-day.level-0 { background: #ebedf0; }
        .activity-day.level-1 { background: #9be9a8; }
        .activity-day.level-2 { background: #40c463; }
        .activity-day.level-3 { background: #30a14e; }
        .activity-day.level-4 { background: #216e39; }
        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            .filters-container {
                flex-direction: column;
                align-items: stretch;
            }
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="hub-container">
        <div class="hub-header">
            <div class="hub-title">üéÆ Azure DevOps Gamification</div>
            <div class="filters-container">
                <div class="filter-group">
                    <label class="filter-label">Ano</label>
                    <select id="yearFilter" class="filter-select">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">M√™s</label>
                    <select id="monthFilter" class="filter-select">
                        <option value="">Todos</option>
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Mar√ßo</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Desenvolvedor</label>
                    <select id="developerFilter" class="filter-select">
                        <option value="">Todos</option>
                    </select>
                </div>
                <button id="applyFilters" class="filter-select" style="background: #0078d4; color: white; border: none; cursor: pointer;">
                    Aplicar Filtros
                </button>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="totalCommits">-</div>
                <div class="metric-label">Total de Commits</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="activeDevelopers">-</div>
                <div class="metric-label">Desenvolvedores Ativos</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="avgCommitsPerDay">-</div>
                <div class="metric-label">Commits/Dia (M√©dia)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="topContributor">-</div>
                <div class="metric-label">Top Contributor</div>
            </div>
        </div>

        <div class="content-grid">
            <div class="content-panel">
                <div class="panel-title">üìä Ranking de Desenvolvedores</div>
                <div id="rankingContent" class="loading">Carregando...</div>
            </div>
            
            <div class="content-panel">
                <div class="panel-title">üåê Code Graph - Colabora√ß√£o em Arquivos</div>
                <div id="codegraphContent" class="codegraph-container">
                    <div class="loading">Carregando grafo...</div>
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #0078d4;"></div>
                        <span>Desenvolvedores</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #28a745;"></div>
                        <span>Arquivos</span>
                    </div>
                </div>
            </div>

            <div class="content-panel full-width-panel">
                <div class="panel-title">üìà Atividade dos Commits (√öltimos 12 meses)</div>
                <div id="activityChart" class="chart-container">
                    <div class="loading">Carregando gr√°fico de atividade...</div>
                </div>
            </div>

            <div class="content-panel full-width-panel">
                <div class="panel-title">üìÖ Heatmap de Contribui√ß√µes (estilo GitHub)</div>
                <div id="contributionHeatmap">
                    <div class="loading">Carregando heatmap...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://your-api-endpoint.azurewebsites.net';
        let currentContext = {};
        let currentToken = '';

        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformStyles: true
        });

        VSS.ready(async () => {
            try {
                const webContext = VSS.getWebContext();
                currentContext = {
                    organization: webContext.account.name,
                    project: webContext.project.name
                };

                currentToken = await VSS.getAccessToken();
                
                initializeFilters();
                loadData();
                
                document.getElementById('applyFilters').addEventListener('click', loadData);
                
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                showError('Erro ao inicializar o hub de gamifica√ß√£o');
            }
        });

        function initializeFilters() {
            // Popula filtro de anos - √∫ltimos 3 anos
            const yearSelect = document.getElementById('yearFilter');
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= currentYear - 2; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            
            // Define ano atual como padr√£o
            yearSelect.value = currentYear;
        }

        async function loadData() {
            const filters = getFilters();
            
            try {
                // Carregamento paralelo de dados para melhor performance
                const [metricsData, rankingData, codeGraphData] = await Promise.all([
                    loadMetrics(filters),
                    loadRanking(filters),
                    loadCodeGraph()
                ]);

                updateMetrics(metricsData);
                updateRanking(rankingData);
                updateCodeGraph(codeGraphData);
                updateActivityChart(metricsData);
                updateContributionHeatmap(metricsData);
                updateDeveloperFilter(rankingData);
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showError('Erro ao carregar dados do Azure DevOps');
            }
        }

        function getFilters() {
            return {
                year: document.getElementById('yearFilter').value,
                month: document.getElementById('monthFilter').value,
                developer: document.getElementById('developerFilter').value
            };
        }

        async function loadMetrics(filters) {
            const params = new URLSearchParams({
                organization: currentContext.organization,
                project: currentContext.project,
                ...(filters.year && { year: filters.year }),
                ...(filters.month && { month: filters.month }),
                ...(filters.developer && { author: filters.developer })
            });

            const response = await fetch(`${API_BASE_URL}/api/metrics/commits?${params}`, {
                headers: {
                    'Authorization': `Bearer ${currentToken}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        }

        async function loadRanking(filters) {
            const params = new URLSearchParams({
                organization: currentContext.organization,
                project: currentContext.project,
                ...(filters.year && { year: filters.year }),
                ...(filters.month && { month: filters.month })
            });

            const response = await fetch(`${API_BASE_URL}/api/ranking/developers?${params}`, {
                headers: {
                    'Authorization': `Bearer ${currentToken}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        }

        async function loadCodeGraph() {
            const params = new URLSearchParams({
                organization: currentContext.organization,
                project: currentContext.project
            });

            const response = await fetch(`${API_BASE_URL}/api/codegraph?${params}`, {
                headers: {
                    'Authorization': `Bearer ${currentToken}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        }

        function updateMetrics(data) {
            document.getElementById('totalCommits').textContent = data.totalCommits || 0;
            
            const developerCount = Object.keys(data.commitsByAuthor || {}).length;
            document.getElementById('activeDevelopers').textContent = developerCount;
            
            const totalDays = Object.keys(data.commitsByDate || {}).length;
            const avgCommits = totalDays > 0 ? Math.round(data.totalCommits / totalDays) : 0;
            document.getElementById('avgCommitsPerDay').textContent = avgCommits;

            // Top contributor
            const topDev = Object.entries(data.commitsByAuthor || {})
                .sort(([,a], [,b]) => b - a)[0];
            document.getElementById('topContributor').textContent = 
                topDev ? topDev[0].split(' ')[0] : '-';
        }

        function updateRanking(ranking) {
            const contentDiv = document.getElementById('rankingContent');
            
            if (!ranking || ranking.length === 0) {
                contentDiv.innerHTML = '<div class="error">Nenhum dado de ranking dispon√≠vel</div>';
                return;
            }

            // Tabela de ranking com dados detalhados
            const tableHTML = `
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>Posi√ß√£o</th>
                            <th>Desenvolvedor</th>
                            <th>Commits</th>
                            <th>Score</th>
                            <th>√öltimo Commit</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${ranking.slice(0, 10).map((dev, index) => `
                            <tr>
                                <td><span class="rank-number">#${index + 1}</span></td>
                                <td>${dev.developerName}</td>
                                <td>${dev.commitCount}</td>
                                <td>${Math.round(dev.score)}</td>
                                <td>${new Date(dev.lastCommitDate).toLocaleDateString('pt-BR')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            contentDiv.innerHTML = tableHTML;
        }

        function updateDeveloperFilter(ranking) {
            const select = document.getElementById('developerFilter');
            const currentValue = select.value;
            
            // Limpa op√ß√µes existentes (exceto "Todos")
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Adiciona desenvolvedores do ranking
            ranking.forEach(dev => {
                const option = document.createElement('option');
                option.value = dev.developerName;
                option.textContent = dev.developerName;
                select.appendChild(option);
            });
            
            // Restaura valor selecionado se ainda existe
            if (currentValue && [...select.options].some(opt => opt.value === currentValue)) {
                select.value = currentValue;
            }
        }

        function updateCodeGraph(graphData) {
            const container = document.getElementById('codegraphContent');
            container.innerHTML = ''; // Limpa conte√∫do anterior

            if (!graphData.nodes || graphData.nodes.length === 0) {
                container.innerHTML = '<div class="error">Sem dados para exibir o grafo</div>';
                return;
            }

            // Implementa√ß√£o simplificada do Code Graph com D3.js
            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Limita√ß√£o para performance - m√°ximo 50 n√≥s
            const limitedNodes = graphData.nodes.slice(0, 50);
            const limitedLinks = graphData.links.filter(link => 
                limitedNodes.some(n => n.id === link.source) && 
                limitedNodes.some(n => n.id === link.target)
            );

            // Simula√ß√£o de for√ßa para layout do grafo
            const simulation = d3.forceSimulation(limitedNodes)
                .force('link', d3.forceLink(limitedLinks).id(d => d.id).distance(60))
                .force('charge', d3.forceManyBody().strength(-200))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(20));

            // Links
            const link = svg.append('g')
                .selectAll('line')
                .data(limitedLinks)
                .enter().append('line')
                .attr('stroke', '#999')
                .attr('stroke-opacity', 0.4)
                .attr('stroke-width', d => Math.min(3, Math.sqrt(d.weight)));

            // N√≥s
            const node = svg.append('g')
                .selectAll('circle')
                .data(limitedNodes)
                .enter().append('circle')
                .attr('r', d => Math.max(4, Math.min(15, Math.sqrt(d.commitCount) * 2)))
                .attr('fill', d => d.type === 'author' ? '#0078d4' : '#28a745')
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Labels (apenas para n√≥s importantes)
            const label = svg.append('g')
                .selectAll('text')
                .data(limitedNodes.filter(d => d.commitCount > 2))
                .enter().append('text')
                .text(d => d.name.length > 15 ? d.name.substring(0, 12) + '...' : d.name)
                .attr('font-size', 10)
                .attr('dx', 15)
                .attr('dy', 4)
                .attr('fill', '#333');

            // Tooltips
            node.append('title')
                .text(d => `${d.name}\nTipo: ${d.type === 'author' ? 'Desenvolvedor' : 'Arquivo'}\nCommits: ${d.commitCount}`);

            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => Math.max(20, Math.min(width - 20, d.x)))
                    .attr('cy', d => Math.max(20, Math.min(height - 20, d.y)));

                label
                    .attr('x', d => Math.max(20, Math.min(width - 100, d.x)))
                    .attr('y', d => Math.max(20, Math.min(height - 20, d.y)));
            });

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        function updateActivityChart(data) {
            const container = document.getElementById('activityChart');
            container.innerHTML = '';

            if (!data.commitsByDate || Object.keys(data.commitsByDate).length === 0) {
                container.innerHTML = '<div class="error">Sem dados de atividade</div>';
                return;
            }

            // Criar gr√°fico de linha simples para atividade mensal
            const width = container.clientWidth;
            const height = container.clientHeight;
            const margin = { top: 20, right: 30, bottom: 40, left: 50 };

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Processar dados por m√™s
            const monthlyData = d3.rollup(
                Object.entries(data.commitsByDate).map(([date, count]) => ({
                    date: new Date(date),
                    count: count
                })),
                v => d3.sum(v, d => d.count),
                d => d3.timeMonth(d.date)
            );

            const chartData = Array.from(monthlyData, ([date, count]) => ({ date, count }))
                .sort((a, b) => a.date - b.date);

            if (chartData.length === 0) {
                container.innerHTML = '<div class="error">Dados insuficientes para gr√°fico</div>';
                return;
            }

            const xScale = d3.scaleTime()
                .domain(d3.extent(chartData, d => d.date))
                .range([margin.left, width - margin.right]);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(chartData, d => d.count)])
                .range([height - margin.bottom, margin.top]);

            const line = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.count))
                .curve(d3.curveMonotoneX);

            // Linha do gr√°fico
            svg.append('path')
                .datum(chartData)
                .attr('fill', 'none')
                .attr('stroke', '#0078d4')
                .attr('stroke-width', 2)
                .attr('d', line);

            // Pontos
            svg.selectAll('.dot')
                .data(chartData)
                .enter().append('circle')
                .attr('class', 'dot')
                .attr('cx', d => xScale(d.date))
                .attr('cy', d => yScale(d.count))
                .attr('r', 4)
                .attr('fill', '#0078d4');

            // Eixos
            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat('%b %Y')));

            svg.append('g')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(yScale));
        }

        function updateContributionHeatmap(data) {
            const container = document.getElementById('contributionHeatmap');
            container.innerHTML = '';

            if (!data.commitsByDate || Object.keys(data.commitsByDate).length === 0) {
                container.innerHTML = '<div class="error">Sem dados para heatmap</div>';
                return;
            }

            // Criar heatmap estilo GitHub
            const now = new Date();
            const oneYearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
            
            const heatmapContainer = document.createElement('div');
            heatmapContainer.className = 'activity-calendar';
            
            // Calcular n√≠veis de atividade
            const commitCounts = Object.entries(data.commitsByDate).reduce((acc, [date, count]) => {
                acc[date] = count;
                return acc;
            }, {});

            const maxCommits = Math.max(...Object.values(commitCounts));
            
            // Gerar todos os dias do √∫ltimo ano
            const current = new Date(oneYearAgo);
            while (current <= now) {
                const dateStr = current.toISOString().split('T')[0];
                const commitCount = commitCounts[dateStr] || 0;
                
                const level = maxCommits > 0 ? Math.ceil((commitCount / maxCommits) * 4) : 0;
                
                const dayElement = document.createElement('div');
                dayElement.className = `activity-day level-${level}`;
                dayElement.title = `${dateStr}: ${commitCount} commits`;
                
                heatmapContainer.appendChild(dayElement);
                current.setDate(current.getDate() + 1);
            }

            container.appendChild(heatmapContainer);

            // Adicionar legenda
            const legend = document.createElement('div');
            legend.style.marginTop = '10px';
            legend.style.fontSize = '12px';
            legend.style.color = '#666';
            legend.innerHTML = 'Menos ';
            
            for (let i = 0; i <= 4; i++) {
                const square = document.createElement('span');
                square.className = `activity-day level-${i}`;
                square.style.display = 'inline-block';
                square.style.margin = '0 2px';
                legend.appendChild(square);
            }
            
            legend.appendChild(document.createTextNode(' Mais'));
            container.appendChild(legend);
        }

        function showError(message) {
            document.getElementById('rankingContent').innerHTML = `<div class="error">${message}</div>`;
            document.getElementById('codegraphContent').innerHTML = `<div class="error">${message}</div>`;
            document.getElementById('activityChart').innerHTML = `<div class="error">${message}</div>`;
            document.getElementById('contributionHeatmap').innerHTML = `<div class="error">${message}</div>`;
        }

        VSS.notifyLoadSucceeded();
    </script>
</body>
</html>